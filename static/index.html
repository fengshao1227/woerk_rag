<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS | 知识库助手</title>
    <!-- 引入 Markdown 渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 引入科技感字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* 核心色板 */
            --primary: #00f3ff;
            --primary-dim: rgba(0, 243, 255, 0.15);
            --primary-glow: rgba(0, 243, 255, 0.4);

            --secondary: #bc13fe;
            --secondary-dim: rgba(188, 19, 254, 0.15);

            --bg-dark: #050505;
            --bg-panel: #0a0e17;
            --bg-input: #0f1420;

            --border: #1f2937;
            --border-active: #374151;

            --text-main: #e0e6ed;
            --text-dim: #94a3b8;
            --text-dark: #000;

            --success: #00ff9d;
            --error: #ff0055;

            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-image:
                radial-gradient(circle at 50% 0%, #1a1f35 0%, transparent 50%),
                linear-gradient(0deg, rgba(0,243,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,243,255,0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- Header --- */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            padding: 0 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .logo-text {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1.5rem;
            color: #fff;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .status-badge {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            padding: 4px 8px;
            border: 1px solid var(--success);
            color: var(--success);
            background: rgba(0, 255, 157, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--success);
            animation: pulse 2s infinite;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 10px var(--primary-dim);
        }

        .btn-primary {
            background: rgba(0, 243, 255, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.5rem 1.2rem;
            border-radius: 6px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .btn-primary:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 20px var(--primary-glow);
        }

        /* --- Main Chat --- */
        main {
            position: fixed;
            top: 70px;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            overflow: hidden;
        }

        #chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            scroll-behavior: smooth;
            min-height: 0; /* 关键：让 flex 子元素可以滚动 */
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            opacity: 1;
            transition: opacity 0.5s;
        }

        .welcome-title {
            font-family: var(--font-display);
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(to right, #fff, var(--text-dim));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .example-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
            max-width: 600px;
        }

        .example-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }

        .example-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .example-card h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .example-card p {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        /* Messages */
        .message-row {
            display: flex;
            flex-direction: column;
            width: 100%;
            animation: slideUp 0.3s ease-out;
        }

        .message-row.user {
            align-items: flex-end;
        }

        .message-row.ai {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 85%;
            padding: 1.2rem 1.5rem;
            border-radius: 12px;
            position: relative;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .user .message-bubble {
            background: var(--primary-dim);
            border: 1px solid var(--primary);
            color: #fff;
            border-bottom-right-radius: 2px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.05);
        }

        .ai .message-bubble {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-bottom-left-radius: 2px;
        }

        .ai-avatar, .user-avatar {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            margin-bottom: 6px;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Sources Section */
        .sources-container {
            margin-top: 12px;
            width: 100%;
            max-width: 85%;
        }

        .sources-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--secondary);
            cursor: pointer;
            padding: 6px 0;
            user-select: none;
            transition: color 0.2s;
        }

        .sources-header:hover { color: #d06bff; }
        .sources-header svg { transition: transform 0.3s; }
        .sources-header.active svg { transform: rotate(90deg); }

        .sources-list {
            display: none;
            margin-top: 8px;
            gap: 8px;
            flex-direction: column;
        }

        .sources-list.active { display: flex; }

        .source-item {
            background: rgba(0,0,0,0.4);
            border-left: 2px solid var(--secondary);
            padding: 10px;
            font-size: 0.85rem;
            border-radius: 0 4px 4px 0;
        }

        .source-title {
            color: var(--text-main);
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
        }

        .source-snippet {
            color: var(--text-dim);
            font-size: 0.8rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- Input Area --- */
        .input-container {
            padding: 1.5rem 2rem;
            background: var(--bg-dark);
            border-top: 1px solid var(--border);
            z-index: 20;
            flex-shrink: 0; /* 防止被压缩 */
        }

        .input-wrapper {
            position: relative;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-dim);
        }

        input[type="text"] {
            width: 100%;
            background: transparent;
            border: none;
            padding: 1.2rem 4rem 1.2rem 1.5rem;
            color: #fff;
            font-family: var(--font-body);
            font-size: 1rem;
        }

        input[type="text"]:focus { outline: none; }

        .send-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 0 10px var(--primary);
        }

        .send-btn:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        /* --- Modal --- */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-backdrop.visible {
            opacity: 1;
        }

        .modal {
            background: var(--bg-panel);
            border: 1px solid var(--secondary);
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            padding: 2rem;
            transform: scale(0.9);
            transition: transform 0.3s;
            box-shadow: 0 0 40px rgba(188, 19, 254, 0.15);
        }

        .modal-backdrop.visible .modal { transform: scale(1); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        .modal-title {
            font-family: var(--font-display);
            color: var(--secondary);
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-btn:hover { color: #fff; }

        .form-group { margin-bottom: 1.2rem; }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: #fff;
            padding: 0.8rem;
            border-radius: 6px;
            font-family: var(--font-body);
        }

        .form-textarea { height: 150px; resize: vertical; }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .submit-btn {
            width: 100%;
            background: var(--secondary);
            color: #fff;
            border: none;
            padding: 1rem;
            border-radius: 6px;
            font-family: var(--font-display);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .submit-btn:hover {
            box-shadow: 0 0 20px var(--secondary-dim);
            background: #d06bff;
        }

        /* Utilities */
        .hidden { display: none !important; }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.8rem; }
        .prose h1, .prose h2, .prose h3 { margin: 1rem 0 0.5rem; color: #fff; font-family: var(--font-display); }
        .prose ul, .prose ol { margin-left: 1.5rem; margin-bottom: 0.8rem; }
        .prose code {
            background: rgba(255,255,255,0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: var(--font-mono);
            color: var(--primary);
            font-size: 0.9em;
        }
        .prose pre {
            background: #111;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.8rem 0;
            border: 1px solid var(--border);
        }
        .prose pre code {
            background: transparent;
            padding: 0;
            color: #ccc;
        }

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading Indicator */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 10px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: scale(0.6); opacity: 0.4; } 50% { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo-container">
            <div class="logo-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div class="logo-text">NEXUS</div>
            <div class="status-badge">
                <div class="status-dot"></div>
                Online
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-icon" onclick="clearHistory()" title="清空历史">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </button>
            <button class="btn-primary" onclick="openModal()">+ 添加知识</button>
        </div>
    </header>

    <!-- Main Chat -->
    <main>
        <div id="chat-history">
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="welcome-screen">
                <h1 class="welcome-title">SYSTEM READY</h1>
                <p style="color: var(--text-dim); margin-bottom: 2rem;">检索增强生成系统 | RAG KNOWLEDGE BASE</p>

                <div class="example-grid">
                    <div class="example-card" onclick="setInput('这个项目的主要技术架构是什么？')">
                        <h4>项目架构</h4>
                        <p>查询当前系统的技术栈与设计模式</p>
                    </div>
                    <div class="example-card" onclick="setInput('如何部署这套系统？')">
                        <h4>部署指南</h4>
                        <p>获取环境配置与启动步骤</p>
                    </div>
                    <div class="example-card" onclick="setInput('系统的核心功能有哪些？')">
                        <h4>功能概览</h4>
                        <p>了解 RAG 检索与知识管理能力</p>
                    </div>
                    <div class="example-card" onclick="setInput('最近更新了什么内容？')">
                        <h4>变更日志</h4>
                        <p>查询知识库中的最新条目</p>
                    </div>
                </div>
            </div>
            <!-- Messages will appear here -->
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="输入指令或问题..." autocomplete="off" onkeydown="handleEnter(event)">
                <button class="send-btn" onclick="sendMessage()" id="send-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Add Knowledge Modal -->
    <div class="modal-backdrop" id="knowledge-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">UPLOAD KNOWLEDGE</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">标题 (可选)</label>
                <input type="text" class="form-input" id="k-title" placeholder="输入知识标题...">
            </div>
            <div class="form-group">
                <label class="form-label">分类</label>
                <select class="form-select" id="k-category">
                    <option value="general">通用 (General)</option>
                    <option value="project">项目文档 (Project)</option>
                    <option value="skill">技术技能 (Skill)</option>
                    <option value="note">随笔笔记 (Note)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">内容详情</label>
                <textarea class="form-textarea" id="k-content" placeholder="输入 Markdown 格式的知识内容..."></textarea>
            </div>
            <button class="submit-btn" onclick="submitKnowledge()" id="k-submit">执行写入</button>
        </div>
    </div>

    <!-- Script -->
    <script>
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const welcomeScreen = document.getElementById('welcome-screen');
        const modal = document.getElementById('knowledge-modal');
        let isProcessing = false;

        // 设置输入框内容
        function setInput(text) {
            userInput.value = text;
            userInput.focus();
        }

        // 回车发送
        function handleEnter(e) {
            if (e.key === 'Enter' && !isProcessing) {
                sendMessage();
            }
        }

        // 打开/关闭模态框
        function openModal() {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function closeModal() {
            modal.classList.remove('visible');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // 点击背景关闭模态框
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // 发送消息逻辑
        async function sendMessage() {
            const question = userInput.value.trim();
            if (!question) return;

            // UI 状态更新
            isProcessing = true;
            document.getElementById('send-btn').disabled = true;
            if (welcomeScreen) welcomeScreen.style.display = 'none';

            // 添加用户消息
            appendMessage('user', question);
            userInput.value = '';

            // 添加 Loading 占位
            const loadingId = appendLoading();

            try {
                // API 请求
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        top_k: 4,
                        use_history: true
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                // 移除 Loading，显示 AI 回答
                removeLoading(loadingId);
                await typeWriterEffect(data.answer, data.sources);

            } catch (error) {
                removeLoading(loadingId);
                appendMessage('ai', `**SYSTEM ERROR**: ${error.message}`);
            } finally {
                isProcessing = false;
                document.getElementById('send-btn').disabled = false;
                userInput.focus();
            }
        }

        // 添加消息到界面
        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message-row ${role}`;

            const avatarText = role === 'user' ? 'OPERATOR' : 'NEXUS AI';
            const bubbleContent = role === 'user' ? text : marked.parse(text);

            div.innerHTML = `
                <div class="${role === 'user' ? 'user-avatar' : 'ai-avatar'}">${avatarText}</div>
                <div class="message-bubble prose">${bubbleContent}</div>
            `;

            chatHistory.appendChild(div);
            scrollToBottom();
            return div;
        }

        // 添加 Loading 动画
        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message-row ai';
            div.innerHTML = `
                <div class="ai-avatar">NEXUS AI</div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatHistory.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // 打字机效果 + 来源显示
        async function typeWriterEffect(text, sources) {
            const div = document.createElement('div');
            div.className = 'message-row ai';
            div.innerHTML = `
                <div class="ai-avatar">NEXUS AI</div>
                <div class="message-bubble prose"></div>
            `;
            chatHistory.appendChild(div);

            const contentDiv = div.querySelector('.message-bubble');
            let currentText = '';

            // 简单的打字模拟 (可以优化为按 token 或句子)
            const step = 20; // ms
            const chars = text.split('');

            for (let char of chars) {
                currentText += char;
                // 每几个字符渲染一次 Markdown 以保持性能，或者最后渲染
                // 这里为了简单，我们最后渲染，中间只显示纯文本或简单的
                contentDiv.innerHTML = marked.parse(currentText + '▍'); // 光标效果
                chatHistory.scrollTop = chatHistory.scrollHeight;
                await new Promise(r => setTimeout(r, Math.random() * 10 + 10));
            }

            contentDiv.innerHTML = marked.parse(text); // 最终渲染

            // 添加来源
            if (sources && sources.length > 0) {
                const sourcesHtml = sources.map((s, i) => `
                    <div class="source-item">
                        <div class="source-title">SOURCE [0${i+1}] // ${s.title || s.file_path || 'Unknown Doc'}</div>
                        <div class="source-snippet">${s.content?.substring(0, 150) || s.summary || '...'}...</div>
                    </div>
                `).join('');

                const sourceContainer = document.createElement('div');
                sourceContainer.className = 'sources-container';
                sourceContainer.innerHTML = `
                    <div class="sources-header" onclick="toggleSources(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                        DATA SOURCES DETECTED (${sources.length})
                    </div>
                    <div class="sources-list">${sourcesHtml}</div>
                `;
                div.appendChild(sourceContainer);
            }

            scrollToBottom();
        }

        function toggleSources(header) {
            header.classList.toggle('active');
            header.nextElementSibling.classList.toggle('active');
        }

        function scrollToBottom() {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // 提交知识
        async function submitKnowledge() {
            const title = document.getElementById('k-title').value;
            const category = document.getElementById('k-category').value;
            const content = document.getElementById('k-content').value;
            const btn = document.getElementById('k-submit');

            if (!content) {
                alert('内容不能为空');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'UPLOADING...';

            try {
                const response = await fetch('/add_knowledge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        category: category,
                        content: content
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('知识录入成功！');
                    closeModal();
                    document.getElementById('k-title').value = '';
                    document.getElementById('k-content').value = '';
                } else {
                    alert('失败: ' + data.message);
                }
            } catch (e) {
                alert('提交错误: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '执行写入';
            }
        }

        // 清除历史
        async function clearHistory() {
            if(!confirm('确认清除所有对话记忆？')) return;

            try {
                await fetch('/clear_history', { method: 'POST' });
                chatHistory.innerHTML = ''; // 清空界面
                chatHistory.appendChild(welcomeScreen);
                welcomeScreen.style.display = 'flex';
                alert('记忆库已重置');
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>
